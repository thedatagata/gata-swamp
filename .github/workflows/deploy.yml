# .github/workflows/deploy.yml
name: Deploy to Render

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  DENO_ENV: ${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}
  GIT_SHA: ${{ github.sha }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - name: Run tests
        run: deno test --allow-all

      - name: Verify LaunchDarkly Flags
        # This simple check ensures we don't deploy code referencing missing flags
        run: |
          echo "üîç Scanning for flag usage..."
          # Search for FLAGS. usage in the codebase
          grep -r "FLAGS\." . --include="*.tsx" --include="*.ts" || true
          
          echo "‚úÖ Flag references found. (In a real enterprise setup, we would validate these against the LD API)"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=sha

      - name: Create LaunchDarkly deployment event
        # Only run if LD token is present
        if: env.LAUNCHDARKLY_ACCESS_TOKEN != ''
        run: |
          curl -X POST https://app.launchdarkly.com/api/v2/engineering-insights/deployments \
            -H "Authorization: ${{ secrets.LAUNCHDARKLY_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "application": {
                "key": "thedenogatar",
                "name": "TheDenogatar"
              },
              "version": "${{ github.sha }}",
              "environment": "${{ env.DENO_ENV }}",
              "startedAt": "'$(date -u +%s%3N)'",
              "metadata": {
                "branch": "${{ github.ref_name }}",
                "commit": "${{ github.sha }}",
                "author": "${{ github.actor }}"
              }
            }'
        env:
          LAUNCHDARKLY_ACCESS_TOKEN: ${{ secrets.LAUNCHDARKLY_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Trigger Render Deploy
        if: success()
        run: |
          # Trigger deploy with the specific image SHA to ensure consistency
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}&imgURL=ghcr.io/${{ github.repository }}:${{ github.sha }}"

      - name: Update LaunchDarkly deployment status
        if: always() && env.LAUNCHDARKLY_ACCESS_TOKEN != ''
        run: |
          curl -X PATCH "https://app.launchdarkly.com/api/v2/engineering-insights/deployments/${{ env.DENO_ENV }}/thedenogatar/${{ github.sha }}" \
            -H "Authorization: ${{ secrets.LAUNCHDARKLY_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "${{ job.status == 'success' && 'succeeded' || 'failed' }}",
              "endedAt": "'$(date -u +%s%3N)'"
            }'
        env:
          LAUNCHDARKLY_ACCESS_TOKEN: ${{ secrets.LAUNCHDARKLY_ACCESS_TOKEN }}
