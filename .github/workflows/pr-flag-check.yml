# .github/workflows/pr-flag-check.yml
name: PR Flag Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-flags:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find flag references in diff
        id: find-flags
        run: |
          # Get changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          # Search for flag keys
          FLAGS_FOUND=""
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              FLAGS_IN_FILE=$(grep -n "ai-query-provider\|pivot-table-access\|data-materialization\|webllm-access\|ai-config" "$file" || true)
              if [ -n "$FLAGS_IN_FILE" ]; then
                FLAGS_FOUND="$FLAGS_FOUND\n$file:\n$FLAGS_IN_FILE"
              fi
            fi
          done
          
          echo "flags<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FLAGS_FOUND" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Evaluate flags for PR context
        if: steps.find-flags.outputs.flags != ''
        run: |
          echo "ðŸš© Feature flags found in PR:"
          echo "${{ steps.find-flags.outputs.flags }}"

      - name: Comment on PR
        if: steps.find-flags.outputs.flags != ''
        uses: actions/github-script@v7
        with:
          script: |
            const flags = `${{ steps.find-flags.outputs.flags }}`;
            if (flags) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸš© LaunchDarkly Feature Flags Detected\n\nThis PR modifies code that references feature flags:\n\`\`\`\n${flags}\n\`\`\`\n\n**Please verify:**\n- [ ] Flags exist in LaunchDarkly\n- [ ] Targeting rules are configured\n- [ ] Default variations are safe\n- [ ] Code handles all variations properly`
              });
            }